<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hangout Bill Splitter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        .remove-person-button {
            margin-left: 10px;
        }
        .toggler {
        }

        .toggler input {
            display: none;
        }

        .toggler label {
            position: relative;
            border: 1px solid #d6d6d6;
            border-radius: 36px;
            background: #e4e8e8;
            cursor: pointer;
        }

        .toggler label::after {
            display: block;
            border-radius: 100%;
            background-color: #d7062a;
            content: '';
            animation-name: toggler-size;
            animation-duration: 0.15s;
            animation-timing-function: ease-out;
            animation-direction: forwards;
            animation-iteration-count: 1;
            animation-play-state: running;
        }

        .toggler label::after, .toggler label .toggler-on, .toggler label .toggler-off {
            position: absolute;
            top: 50%;
            left: 25%;
            width: 26px;
            height: 26px;
            transform: translateY(-50%) translateX(-50%);
            transition: left 0.15s ease-in-out, background-color 0.2s ease-out, width 0.15s ease-in-out, height 0.15s ease-in-out, opacity 0.15s ease-in-out;
        }

        .toggler label {
            top: -30%;
        }

        .toggler input:checked + label::after, .toggler input:checked + label .toggler-on, .toggler input:checked + label .toggler-off {
            left: 75%;
        }

        .toggler input:checked + label::after {
            background-color: #50ac5d;
            animation-name: toggler-size2;
        }

        .toggler .toggler-on, .toggler .toggler-off {
            opacity: 1;
            z-index: 2;
        }

        .toggler input:checked + label .toggler-off, .toggler input:not(:checked) + label .toggler-on {
            width: 0;
            height: 0;
            opacity: 0;
        }

        .toggler .path {
            fill: none;
            stroke: #fefefe;
            stroke-width: 7px;
            stroke-linecap: round;
            stroke-miterlimit: 10;
        }
        .item-detail-col {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
        }

        @keyframes toggler-size {
        0%, 100% {
            width: 26px;
            height: 26px;
        }

        50% {
            width: 20px;
            height: 20px;
        }
        }

        @keyframes toggler-size2 {
        0%, 100% {
            width: 26px;
            height: 26px;
        }

        50% {
            width: 20px;
            height: 20px;
        }
        }
 
        /* Style for placeholder text in contenteditable */
        [contenteditable]:empty:before {
            content: attr(placeholder);
            pointer-events: none;
            display: block; /* For Firefox */
            color: #9ca3af;
        }
        /* Ensure both add buttons are visible on desktop, overriding the 'hidden' class */
        @media (min-width: 768px) {
            #add-person-btn, #add-item-btn {
                display: flex !important;
            }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 antialiased">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <!-- Main Controls -->
        <div class="flex flex-col md:flex-row justify-center items-center gap-3 mb-8 pt-8">
            <button id="add-person-btn" class="w-full md:w-auto bg-sky-600 text-white font-semibold py-2 px-5 rounded-lg shadow-md hover:bg-sky-700 transition-all duration-300 transform hover:scale-105 flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>
                Add Person
            </button>
            <button id="add-item-btn" class="w-full md:w-auto bg-indigo-600 text-white font-semibold py-2 px-5 rounded-lg shadow-md hover:bg-indigo-700 transition-all duration-300 transform hover:scale-105 flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="12" x2="12" y1="8" y2="16"/><line x1="8" x2="16" y1="12" y2="12"/></svg>
                Add Item
            </button>
        </div>
        
        <!-- Placeholder message -->
        <div id="placeholder" class="text-center text-slate-500 py-10">
            <p>Start by adding people and items to build your expense sheet.</p>
        </div>

        <!-- Main content area -->
        <div id="main-content" class="hidden">
            <!-- Desktop Table View -->
            <div class="hidden md:block bg-white p-4 rounded-xl shadow-lg">
                <div class="overflow-x-auto custom-scrollbar">
                    <table id="desktop-table" class="w-full min-w-[600px] border-collapse">
                        <!-- JS will generate table content here -->
                    </table>
                </div>
            </div>

            <!-- Mobile View -->
            <div class="md:hidden">
                <!-- Mobile Toggle -->
                <div class="flex bg-slate-200 p-1 rounded-lg mb-4">
                    <button id="toggle-items" class="w-1/2 py-2 text-sm font-semibold rounded-md transition-colors duration-300">Items</button>
                    <button id="toggle-people" class="w-1/2 py-2 text-sm font-semibold rounded-md transition-colors duration-300">People</button>
                </div>
                
                <!-- Mobile Items View -->
                <div id="mobile-items-view" class="space-y-3"></div>
                
                <!-- Mobile People View -->
                <div id="mobile-people-view" class="space-y-3 hidden"></div>
            </div>
        </div>

        <!-- Calculation and Results -->
        <div id="calculation-section" class="mt-8 hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold mb-4 text-slate-900">Final Calculation</h2>
                <div class="flex flex-col sm:flex-row items-center gap-4">
                    <div class="relative w-full sm:w-auto flex-grow">
                        <label for="tax-input" class="absolute -top-2 left-2 inline-block bg-white px-1 text-xs font-medium text-slate-500">Tax (%)</label>
                        <input type="number" id="tax-input" placeholder="0" class="w-full px-3 py-2 text-slate-900 bg-transparent border border-slate-300 rounded-md focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition">
                    </div>
                    <button id="calculate-btn" class="w-full sm:w-auto bg-green-600 text-white font-bold py-2.5 px-8 rounded-lg shadow-md hover:bg-green-700 transition-all duration-300 transform hover:scale-105">
                        Calculate
                    </button>
                </div>
                
                <!-- Validation & Results Display -->
                <div id="results-container" class="mt-6 space-y-4"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let people = [];
            let items = [];
            let usage = {}; // key: `p${person.id}-i${item.id}`, value: quantity
            let nextPersonId = 1;
            let nextItemId = 1;
            let toggle_view = "items"

            // --- DOM ELEMENT REFERENCES ---
            const addPersonBtn = document.getElementById('add-person-btn');
            const addItemBtn = document.getElementById('add-item-btn');
            const placeholder = document.getElementById('placeholder');
            const mainContent = document.getElementById('main-content');
            const calculationSection = document.getElementById('calculation-section');
            
            // Desktop
            const desktopTable = document.getElementById('desktop-table');
            
            // Mobile
            const toggleItemsBtn = document.getElementById('toggle-items');
            const togglePeopleBtn = document.getElementById('toggle-people');
            const mobileItemsView = document.getElementById('mobile-items-view');
            const mobilePeopleView = document.getElementById('mobile-people-view');
            
            // Calculation
            const taxInput = document.getElementById('tax-input');
            const calculateBtn = document.getElementById('calculate-btn');
            const resultsContainer = document.getElementById('results-container');

            // --- CORE FUNCTIONS ---
            
            /**
             * Adds a new person to the state with a default name.
             */
            const addPerson = () => {
                const name = `Person ${nextPersonId}`;
                people.push({ id: nextPersonId, name: name });
                nextPersonId++;
                render();
            };

            /**
             * Adds a new item to the state with default values.
             */
            const addItem = () => {
                const name = `Item ${nextItemId}`;
                const price = 10.00; // Default price
                items.push({ id: nextItemId, name: name, price, count: 1 , forAll: false});
                nextItemId++;
                render();
            };

            /**
             * Updates a property of an item (name, price, or count)
             */
            const updateItem = (itemId, property, value) => {
                const item = items.find(i => i.id === itemId);
                if (item) {
                    if(property === 'price' || property === 'count') {
                        const numValue = parseFloat(value);
                        if (!isNaN(numValue) && numValue >= 0) {
                            item[property] = numValue;
                        }
                    } else {
                        item[property] = value;
                    }
                }
            };

            const toggledForAll = (itemId) => {
                const item = items.find(i => i.id === itemId);
                if (item) {
                    item.forAll = !item.forAll;
                }
                console.log(items)
            };
            
            /**
             * Updates a property of a person (name)
             */
            const updatePerson = (personId, property, value) => {
                const person = people.find(p => p.id === personId);
                if (person) {
                    person[property] = value;
                }
            }

            /**
             * Updates the usage of an item by a person
             */
            const updateUsage = (personId, itemId, value) => {
                const key = `p${personId}-i${itemId}`;
                const numValue = parseFloat(value);
                if (!isNaN(numValue) && numValue >= 0) {
                    usage[key] = numValue;
                } else {
                    usage[key] = 0;
                }
            };
            
            /**
             * Deletes a person from the state
             */
            const deletePerson = (personId) => {
                if (confirm('Are you sure you want to delete this person and all their usage data?')) {
                    people = people.filter(p => p.id !== personId);
                    // Clean up usage data
                    Object.keys(usage).forEach(key => {
                        if (key.startsWith(`p${personId}-`)) {
                            delete usage[key];
                        }
                    });
                    render();
                }
            };

            /**
             * Deletes an item from the state
             */
            const deleteItem = (itemId) => {
                if (confirm('Are you sure you want to delete this item and all its usage data?')) {
                    items = items.filter(i => i.id !== itemId);
                    // Clean up usage data
                    Object.keys(usage).forEach(key => {
                        if (key.endsWith(`-i${itemId}`)) {
                            delete usage[key];
                        }
                    });
                    render();
                }
            };

            // --- RENDER FUNCTIONS ---

            /**
             * Main render function to update the entire UI
             */
            const render = () => {
                if (people.length === 0 && items.length === 0) {
                    placeholder.classList.remove('hidden');
                    mainContent.classList.add('hidden');
                    calculationSection.classList.add('hidden');
                } else {
                    placeholder.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                    if (people.length > 0 && items.length > 0) {
                        calculationSection.classList.remove('hidden');
                    } else {
                        calculationSection.classList.add('hidden');
                    }
                }
                
                renderDesktopTable();
                renderMobileItems();
                renderMobilePeople();
                updateMobileToggle(toggle_view);
            };

            /**
             * Renders the desktop table view
             */
            const renderDesktopTable = () => {
                if (items.length === 0 && people.length === 0) {
                    desktopTable.innerHTML = '';
                    return;
                }
                
                let headHTML = '<thead><tr class="bg-slate-50">';
                headHTML += '<th class="p-3 text-left text-sm font-semibold text-slate-600 sticky left-0 bg-slate-50 z-10 w-48">Person</th>';
                items.forEach(item => {
                    headHTML += `<th class="p-3 text-center text-sm font-semibold text-slate-600 min-w-[150px]">
                                    <div class="flex flex-col items-center gap-1">
                                        <div contenteditable="true" placeholder="Item Name" onblur="updateItem(${item.id}, 'name', this.innerText)" class="font-bold w-full text-center outline-none focus:bg-slate-200 rounded px-1">${item.name}</div>
                                        <div class="flex gap-2 text-xs w-full">
                                            <div class="flex-1">
                                                <label class="text-slate-500">Price:</label>
                                                <input type="number" value="${item.price}" oninput="updateItem(${item.id}, 'price', this.value)" class="w-full bg-slate-100 rounded px-1 text-center outline-none focus:ring-1 focus:ring-indigo-400">
                                            </div>
                                            <div class="flex-1">
                                                <label class="text-slate-500">Count:</label>
                                                <input type="number" value="${item.count}" oninput="updateItem(${item.id}, 'count', this.value)" class="w-full bg-slate-100 rounded px-1 text-center outline-none focus:ring-1 focus:ring-indigo-400">
                                            </div>
                                        </div>
                                        <button onclick="deleteItem(${item.id})" class="text-red-500 hover:text-red-700 text-xs mt-1">Remove</button>
                                    </div>
                                 </th>`;
                });
                headHTML += '</tr></thead>';

                let bodyHTML = '<tbody>';
                people.forEach(person => {
                    bodyHTML += `<tr class="border-t border-slate-200 hover:bg-slate-50">
                                    <td class="p-3 font-medium text-slate-800 sticky left-0 bg-white hover:bg-slate-50 z-10 w-48">
                                        <div class="flex items-center gap-2">
                                            <div contenteditable="true" placeholder="Person Name" onblur="updatePerson(${person.id}, 'name', this.innerText)" class="font-bold w-full text-center outline-none focus:bg-slate-200 rounded px-1">${person.name}</div>
                                            <button onclick="deletePerson(${person.id})" class="text-red-500 hover:text-red-700 text-xs">Remove</button>
                                        </div>
                                    </td>`;
                    items.forEach(item => {
                        const key = `p${person.id}-i${item.id}`;
                        const value = usage[key] || '';
                        bodyHTML += `<td class="p-3 text-center">
                                        <input type="number" placeholder="0" value="${value}" oninput="updateUsage(${person.id}, ${item.id}, this.value)" class="w-20 text-center bg-slate-100 border border-slate-200 rounded-md py-1 px-2 focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition">
                                     </td>`;
                    });
                    bodyHTML += '</tr>';
                });
                bodyHTML += '</tbody>';

                desktopTable.innerHTML = headHTML + bodyHTML;
            };

            /**
             * Renders the mobile items list view
             */
            const renderMobileItems = () => {
                if (items.length === 0) {
                    mobileItemsView.innerHTML = '<p class="text-center text-slate-500 p-4">No items added yet.</p>';
                    return;
                }
                
                mobileItemsView.innerHTML = items.map(item => `
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex justify-between items-start">
                             <div contenteditable="true" placeholder="Item Name" onblur="updateItem(${item.id}, 'name', this.innerText)" class="font-bold text-lg text-slate-800 flex-grow outline-none focus:bg-slate-200 rounded -m-1 p-1">${item.name}</div>
                             <button onclick="deleteItem(${item.id})" class="text-red-500 hover:text-red-700 font-semibold text-sm ml-2">Remove</button>
                        </div>
                        <div class="grid grid-cols-3 gap-4 mt-3">
                            <div class="item-detail-col">
                                <label class="text-sm font-medium text-slate-500">Price</label>
                                <input type="number" value="${item.price}" oninput="updateItem(${item.id}, 'price', this.value)" class="w-full mt-1 bg-slate-100 border border-slate-200 rounded-md py-1.5 px-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition">
                            </div>
                            <div class="item-detail-col">
                                <label class="text-sm font-medium text-slate-500">Total Count</label>
                                <input type="number" value="${item.count}" oninput="updateItem(${item.id}, 'count', this.value)" class="w-full mt-1 bg-slate-100 border border-slate-200 rounded-md py-1.5 px-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition">
                            </div>
                            <div class="item-detail-col">
                                <label class="text-sm font-medium text-slate-500">For all</label>
                                <div class="toggler">
                                    <input id="toggler-${item.id}" name="toggler-${item.id}" type="checkbox" ${item.forAll?"checked":""} oninput="toggledForAll(${item.id})">
                                    <label for="toggler-${item.id}">
                                        <svg class="toggler-on" version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 130.2 130.2">
                                            <polyline class="path check" points="100.2,40.2 51.5,88.8 29.8,67.5"></polyline>
                                        </svg>
                                        <svg class="toggler-off" version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 130.2 130.2">
                                            <line class="path line" x1="34.4" y1="34.4" x2="95.8" y2="95.8"></line>
                                            <line class="path line" x1="95.8" y1="34.4" x2="34.4" y2="95.8"></line>
                                        </svg>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            };

            /**
             * Renders the mobile people list view
             */
            const renderMobilePeople = () => {
                if (people.length === 0) {
                    mobilePeopleView.innerHTML = '<p class="text-center text-slate-500 p-4">No people added yet.</p>';
                    return;
                }
                
                mobilePeopleView.innerHTML = people.map(person => `
                    <div class="bg-white p-4 rounded-lg shadow">
                        <details>
                            <summary class="flex justify-between items-center cursor-pointer">
                            <div contenteditable="true" placeholder="Item Name" onblur="updatePerson(${person.id}, 'name', this.innerText)" class="font-bold text-lg text-slate-800 flex-grow outline-none focus:bg-slate-200 rounded -m-1 p-1">${person.name}</div>
                                <div class="flex items-center gap-2">
                                    <button onclick="event.preventDefault(); deletePerson(${person.id})" class="text-red-500 hover:text-red-700 font-semibold text-sm remove-person-button">Remove</button>
                                    <svg class="w-5 h-5 text-slate-500 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </div>
                            </summary>
                            <div class="mt-4 border-t border-slate-200 pt-4 space-y-3">
                                <h4 class="font-semibold text-slate-600">Item Usage:</h4>
                                ${items.filter(item => !item.forAll).length > 0 ? items.filter(item => !item.forAll).map(item => {
                                    const key = `p${person.id}-i${item.id}`;
                                    const value = usage[key] || '';
                                    return `
                                    <div class="flex justify-between items-center">
                                        <span class="text-slate-700">${item.name}</span>
                                        <input type="number" placeholder="0" value="${value}" oninput="updateUsage(${person.id}, ${item.id}, this.value)" class="w-20 text-center bg-slate-100 border border-slate-200 rounded-md py-1 px-2 focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition">
                                    </div>
                                `}).join('') : '<p class="text-sm text-slate-500">No items to assign.</p>'}
                            </div>
                        </details>
                    </div>
                `).join('');
            };
            
            /**
             * Updates the active state of the mobile view toggle and controls Add button visibility
             */
            const updateMobileToggle = (view = 'items') => {
                toggle_view = view;
                if (view === 'items') {
                    renderMobileItems()
                    toggleItemsBtn.classList.add('bg-white', 'text-sky-600', 'shadow');
                    toggleItemsBtn.classList.remove('text-slate-600');
                    togglePeopleBtn.classList.remove('bg-white', 'text-sky-600', 'shadow');
                    togglePeopleBtn.classList.add('text-slate-600');
                    mobileItemsView.classList.remove('hidden');
                    mobilePeopleView.classList.add('hidden');
                    
                    // On mobile, show 'Add Item', hide 'Add Person'
                    addItemBtn.classList.remove('hidden');
                    addPersonBtn.classList.add('hidden');
                } else { // 'people'
                    renderMobilePeople()
                    togglePeopleBtn.classList.add('bg-white', 'text-sky-600', 'shadow');
                    togglePeopleBtn.classList.remove('text-slate-600');
                    toggleItemsBtn.classList.remove('bg-white', 'text-sky-600', 'shadow');
                    toggleItemsBtn.classList.add('text-slate-600');
                    mobilePeopleView.classList.remove('hidden');
                    mobileItemsView.classList.add('hidden');

                    // On mobile, show 'Add Person', hide 'Add Item'
                    addPersonBtn.classList.remove('hidden');
                    addItemBtn.classList.add('hidden');
                }
            }


            // --- CALCULATION LOGIC ---
            const calculate = () => {
                resultsContainer.innerHTML = '';
                let validationErrors = [];
                let validationWarnings = [];
                
                // 1. Validate that usage sums match item counts
                items.filter(item => !item.forAll).forEach(item => {
                    const totalUsed = people.reduce((sum, person) => {
                        const key = `p${person.id}-i${item.id}`;
                        return sum + (usage[key] || 0);
                    }, 0);

                    if (Math.abs(totalUsed - item.count) > 0.01) { // Use tolerance for float comparison
                        const message = `For <strong>${item.name}</strong>, total count is ${item.count}, but sum of usage is ${totalUsed.toFixed(2)}.`;
                        validationWarnings.push(message);
                    }
                });

                // Display validation results
                if (validationErrors.length > 0 || validationWarnings.length > 0) {
                    let validationHTML = '';
                    if (validationErrors.length > 0) {
                        validationHTML += '<div class="p-4 rounded-md bg-red-50 border border-red-200"><h3 class="font-bold text-red-800">Please Fix Errors</h3><ul class="mt-2 list-disc list-inside text-red-700 text-sm space-y-1">';
                        validationErrors.forEach(err => validationHTML += `<li>${err}</li>`);
                        validationHTML += '</ul></div>';
                    }
                    
                    if(validationWarnings.length > 0) {
                        validationHTML += '<div class="mt-3 p-4 rounded-md bg-yellow-50 border border-yellow-200"><h3 class="font-bold text-yellow-800">Usage Mismatches</h3><ul class="mt-2 list-disc list-inside text-yellow-700 text-sm space-y-1">';
                        validationWarnings.forEach(warn => validationHTML += `<li>${warn}</li>`);
                        validationHTML += '</ul></div>';
                    }
                    resultsContainer.innerHTML = validationHTML;
                    if (validationErrors.length > 0) return; // Hard stop for over-assignment
                }

                // 2. Calculate costs if validation passes (or only has warnings)
                const personTotals = people.map(person => ({ ...person, total: 0 }));
                let grandSubtotal = 0;

                items.filter(item => !item.forAll).forEach(item => {
                    const pricePerUnit = item.price;
                    grandSubtotal += item.price * item.count;
                    
                    people.forEach(person => {
                        const key = `p${person.id}-i${item.id}`;
                        const personUsage = usage[key] || 0;
                        const personCostForItem = personUsage * pricePerUnit;
                        
                        const personTotal = personTotals.find(p => p.id === person.id);
                        personTotal.total += personCostForItem;
                    });
                });

                items.filter(item => item.forAll).forEach(item => {
                    const totalItemPrice = item.price * item.count;
                    grandSubtotal += totalItemPrice;
                    if (personTotals.length == 0) {
                        return;
                    }
                    personTotals.forEach(person => {
                        person.total += totalItemPrice / personTotals.length
                    })
                })

                // 3. Calculate tax
                const taxPercentage = (taxInput.value === "" || taxInput.value === null) ? 0 : parseFloat(taxInput.value);
                const totalTax = grandSubtotal * (taxPercentage / 100);

                // 4. Display final results
                let resultsHTML = `<h3 class="text-lg font-bold text-slate-900 border-b pb-2 mb-3">Final Bill</h3>`;
                resultsHTML += '<div class="space-y-2">';

                personTotals.forEach(p => {
                    const taxShare = (p.total * taxPercentage / 100);
                    const finalAmount = p.total + taxShare;
                    
                    resultsHTML += `
                        <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                            <span class="font-semibold text-slate-800">${p.name}</span>
                            <div class="text-right">
                                <span class="font-bold text-lg text-sky-700">${finalAmount.toLocaleString('en-US')}</span>
                                ${taxShare > 0 ? '<div class="text-xs text-slate-500">Subtotal: ' + p.total.toFixed(2) + ' + Tax: ' + taxShare.toFixed(2) + '</div>' : ''}
                            </div>
                        </div>
                    `;
                });
                
                resultsHTML += '</div>';

                const finalGrandTotal = grandSubtotal + totalTax;
                resultsHTML += `
                    <div class="mt-4 pt-4 border-t-2 border-slate-200 flex justify-between items-center">
                        <span class="text-xl font-bold text-slate-900">Grand Total</span>
                        <span class="text-xl font-bold text-slate-900">${finalGrandTotal.toLocaleString('en-US')}</span>
                    </div>
                `;

                // Prepend results to the container so validation messages are still visible
                resultsContainer.innerHTML = resultsHTML + resultsContainer.innerHTML;
            };

            // --- EVENT LISTENERS ---
            addPersonBtn.addEventListener('click', addPerson);
            addItemBtn.addEventListener('click', addItem);
            calculateBtn.addEventListener('click', calculate);
            
            toggleItemsBtn.addEventListener('click', () => updateMobileToggle('items'));
            togglePeopleBtn.addEventListener('click', () => updateMobileToggle('people'));
            
            // Make functions globally accessible for inline event handlers
            window.updateItem = updateItem;
            window.updatePerson = updatePerson;
            window.updateUsage = updateUsage;
            window.deletePerson = deletePerson;
            window.deleteItem = deleteItem;
            window.toggledForAll = toggledForAll;

            // --- INITIALIZATION ---
            render();
        });
    </script>
</body>
</html>
